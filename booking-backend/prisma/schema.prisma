generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum SeatType {
  SEAT
  VIP
  SINGLE_BED
  DOUBLE_BED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum Role {
  USER
  ADMIN
}

// --- MODELS ---

model User {
  id                        String    @id @default(uuid())
  email                     String    @unique
  name                      String
  passwordHash              String
  phone                     String
  role                      Role      @default(USER)
  currentHashedRefreshToken String?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  bookings                  Booking[]
}

model Bus {
  id          String @id @default(uuid())
  plateNumber String @unique
  name        String
  totalSeats  Int    @default(0)

  seats Seat[]
  trips Trip[]
}

model Seat {
  id    String   @id @default(uuid())
  busId String
  label String
  floor Int
  row   Int
  col   Int
  type  SeatType

  bus     Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
  tickets Ticket[]

  @@unique([busId, label])
}

model Station {
  id       String @id @default(uuid())
  name     String
  address  String
  province String

  // Relation cho Booking (Khách lên/xuống ở đâu)
  bookingDepartures Booking[]       @relation("BookingDep")
  bookingArrivals   Booking[]       @relation("BookingArr")
  route_station     Route_Station[]
}

model Trip {
  id            String   @id @default(uuid())
  busId         String
  routeId       String
  departureTime DateTime

  bus   Bus   @relation(fields: [busId], references: [id])
  route Route @relation(fields: [routeId], references: [id])

  bookings Booking[]
  tickets  Ticket[]
}

model Route {
  id   String @id @default(uuid())
  name String
  // basePrice Decimal // giá tiền giữa 2 điểm dừng gần kề // thay đổi cần họp

  route_station Route_Station[]
  trips         Trip[]
}

model Route_Station {
  id                String  @id @default(uuid())
  routeId           String
  stationId         String
  order             Int
  durationFromStart Int     @default(0)
  distanceFromStart Int     @default(0) // đơn vị km
  priceFromStart    Decimal @default(0) // Giá vé từ điểm đầu đến trạm này // thay đổi cần họp

  route   Route   @relation(fields: [routeId], references: [id], onDelete: Cascade)
  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)

  @@unique([routeId, order]) // Thứ tự trong 1 tuyến là duy nhất
  @@unique([routeId, stationId]) // 1 tuyến không đi qua 1 trạm 2 lần
}

model Booking {
  id          String        @id @default(uuid())
  userId      String
  tripId      String
  status      BookingStatus @default(PENDING)
  totalAmount Decimal

  departureStationId String
  arrivalStationId   String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiredAt DateTime?

  paymentTime   DateTime?  
  paymentRef    String?

  user             User     @relation(fields: [userId], references: [id])
  trip             Trip     @relation(fields: [tripId], references: [id])
  departureStation Station  @relation("BookingDep", fields: [departureStationId], references: [id])
  arrivalStation   Station  @relation("BookingArr", fields: [arrivalStationId], references: [id])
  tickets          Ticket[]
}

model Ticket {
  id        String @id @default(uuid())
  bookingId String
  seatId    String
  tripId    String // Thêm tripId vào đây để check trùng ghế cho nhanh

  fromOrder Int
  toOrder   Int

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  seat    Seat    @relation(fields: [seatId], references: [id])
  trip    Trip    @relation(fields: [tripId], references: [id])

  @@index([tripId, seatId]) // Tìm vé theo ghế
  @@index([tripId, fromOrder, toOrder]) // Tìm vé chồng lấn (Overlap)
}
